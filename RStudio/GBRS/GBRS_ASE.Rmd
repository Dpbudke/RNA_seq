---
title: "GBRS ASE"
Date: 11/4/24
output: html_notebook
---

I implemented the GBRS (formerly EMASE - Churchill Lab) ASE pipeline on Ceres, and here I'm taking the isoform-level counts tables to assess deferentially expressed isoforms (DEI)/functional annotations. I want to assess the DEIs in my CCRIXs, and look for cross-over between my DEGs data, and ideally be able to suggest genes, followed by isoform level resolution, associated with MetS phenotypes.

# **1. Load Packages**

```{r}
# Clear environment to start fresh (if necessary)
rm(list = ls())

library(openxlsx)
library(BiocManager)
library(edgeR)
library(topGO)
library(clusterProfiler)
library(dplyr)
library(Rgraphviz)
library(org.Mm.eg.db)
library(gplots)
library(RColorBrewer)
library(ggplot2)
library(scales)
library(devtools)
#devtools::install_github("javadnoorb/pathview")
#library(pathview)
library(enrichplot)
library(gridExtra)
library(fs)
library(tidyr) 
library(reticulate)
```

# 2. Load Master Counts and haplotype file

```{r}
Master_counts <- read.csv("Data/Final_counts/combined_counts.csv", row.names = 1)
colnames(Master_counts) <- sub("^X", "", colnames(Master_counts))

Master_haplo <- read.csv("Data/Final_counts/combined_haplotypes.csv", row.names = 1)
colnames(Master_haplo) <- sub("^X", "", colnames(Master_haplo))
```

# 3. Load annotation file

```{r}
# must use consistent anno throughout ASE pipeline-- version 105 

anno <- readRDS("Data/genes_with_id.rds") # this directly reads in 105 

# Create vector of chromosomes we want to keep
keep_chr <- c(as.character(1:19), "X")

# Filter the dataframe to keep only those chromosomes
anno_filtered <- anno[anno$chromosome_name %in% keep_chr, ]

# Get genes from Master_counts
master_genes <- rownames(Master_counts)

# Filter anno_filtered to keep only genes present in Master_counts
anno_filtered <- anno_filtered[anno_filtered$ensembl_gene_id %in% master_genes, ]
```

# **4. Derive experiment metadata**

```{r}
#Note: I should have 176 CCRIX samples 

# Load in Excel file and read the "pups" sheet
pup <- read.xlsx("Data/Data4R_db_03042024_FINAL.xlsx", sheet = "Pups", na.strings = c(""," ","NA","N/A","na", "n/a"), skipEmptyRows = TRUE)

# Add Cross column 
pup$Cross <- paste0(pup$CC.Mom.Strain, "x", pup$CC.Dad.Strain)

#Edit Low Protein to LP and AIN-93G to AIN (removing space/- since it messes up contrasts function)
pup$Diet <- gsub("Low Protein", "LP", pup$Diet)
pup$Diet <- gsub("AIN-93G", "AIN", pup$Diet)

# Select only the required columns
metadata_subset <- pup[, c("Animal.ID", "Sex", "Diet", "Cross")]

# Get the sample names from the counts data
sample_names <- colnames(Master_counts)

# Filter the metadata to include only the samples present in the counts data
metadata_filtered <- metadata_subset %>%  filter(`Animal.ID` %in% sample_names)

# First create filtered metadata without outliers
#metadata_filtered_no_outliers <- metadata_filtered %>%
 # filter(!`Animal.ID` %in% c("120", "63", "18"))

# Get the sample names from the metadata subset
metadata_samples <- metadata_filtered$`Animal.ID`

# Filter the counts data to only include the CCRIX samples
sample_names <- as.character(metadata_samples)
matching_columns <- intersect(sample_names, names(Master_counts))
Master_counts <- Master_counts[, matching_columns]

# Filter the haplo data to only include the CCRIX samples
Master_haplo <- Master_haplo[, matching_columns]

# Ensure that the column names in counts_filtered match the Animal ID in metadata_filtered
all_samples_present <- all(colnames(Master_counts) %in% metadata_filtered$`Animal.ID`)

# Verify that the order matches
all(colnames(Master_counts) == metadata_filtered$`Animal.ID`)

# If the above returns TRUE, your metadata and counts are now correctly ordered and matched

# Final files = Master_counts, Master_haplo, and metadata_filtered
# Final files = Master_counts_no_outliers and metadata_filtered_no_outliers
```

## **QC: Top Genes**

```{r}

# Calculate the total counts for each gene (row) by summing across all samples (columns)
gene_sums <- rowSums(Master_counts)

# Order the rows by total counts from most to least
counts_ordered <- Master_counts[order(gene_sums, decreasing = TRUE), ]

# View the top rows of the ordered table
head(counts_ordered)

#Top 5 genes: 

#Albumin, Transferrin, ApoE, C3 (complement component 3), Ahsg
```

## QC: MSD Plot

```{r}
# RIX 1,2 and 3

Cross = metadata_filtered$Cross
Diet = metadata_filtered$Diet
Sex = metadata_filtered$Sex
mm <- model.matrix(~0 + Cross + Diet + Sex, data = metadata_filtered)
d0 <- DGEList(Master_counts)
d0 <- calcNormFactors(d0)
keep <- filterByExpr(d0, mm, large.n =8) 
d <- d0[keep,]

plotMDSWithLabels <- function(d, metadata_filtered, point_size=1, title="MDS Plot of Allele-Specific Expression") {
  # Convert Cross to factor
  metadata_filtered$Cross <- factor(metadata_filtered$Cross)
  
  # Set up plotting margins for legend space
  par(mar=c(5,4,4,8))
  
  # Create the MDS plot
  mds_plot <- plotMDS(d, 
                      col = as.numeric(metadata_filtered$Cross),
                      cex = point_size,
                      main = title,
                      xlab = "Leading logFC dim 1",
                      ylab = "Leading logFC dim 2",
                      plot = FALSE)
  
  # Create the actual plot
  plot(mds_plot$x, 
       mds_plot$y,
       col = as.numeric(metadata_filtered$Cross),
       pch = 16,
       cex = point_size,
       main = title,
       xlab = "Leading logFC dim 1",
       ylab = "Leading logFC dim 2")
  
  # Add legend outside plot area
  legend("right",
         legend = levels(metadata_filtered$Cross),
         col = 1:length(levels(metadata_filtered$Cross)),
         pch = 16,
         title = "Cross",
         xpd = TRUE,
         inset = c(-0.2, 0))
}

# Usage example:
plotMDSWithLabels(d, metadata_filtered)

# Clusters samples by RIX very well, and interestingly, theres 2 subgroups for each RIX with both crosses in both subsclusters -- seems promising for ASE. Also, looks far more similar to my normal RNA-seq MSD plot 

## Consider grouping by each cluster, checking if specific alleles are driving this obvious difference 
```

## **QC: Gene-level QC**

```{r}
# Function to calculate standard deviation and other QC metrics
calc_gene_stats <- function(counts_df) {
  # Calculate standard deviation for each gene
  gene_sd <- apply(counts_df, 1, sd)
  
  # Calculate mean counts per gene
  gene_means <- rowMeans(counts_df)
  
  # Calculate coefficient of variation (CV)
  gene_cv <- gene_sd / gene_means
  
  # Create summary dataframe
  gene_stats <- data.frame(
    mean_counts = gene_means,
    sd_counts = gene_sd,
    cv = gene_cv,
    zero_counts = rowSums(counts_df == 0)
  )
  
  # Calculate summary statistics
  summary_stats <- list(
    sd_summary = summary(gene_sd),
    mean_summary = summary(gene_means),
    cv_summary = summary(gene_cv),
    genes_with_zeros = sum(gene_stats$zero_counts > 0),
    total_zeros = sum(gene_stats$zero_counts),
    zero_sd_genes = sum(gene_sd == 0),
    nonzero_sd_genes = sum(gene_sd > 0)
  )
  
  return(list(gene_stats = gene_stats, summary_stats = summary_stats))
}

# Run the analysis
qc_results <- calc_gene_stats(Master_counts)

# Create multiple visualizations
library(ggplot2)
library(gridExtra)

# Create better binned histogram with improved readability
p1 <- ggplot(data.frame(sd = qc_results$gene_stats$sd_counts[qc_results$gene_stats$sd_counts > 0]), 
       aes(x = sd)) +
  geom_histogram(breaks = c(0, 0.1, 1, 10, 100, 1000, max(qc_results$gene_stats$sd_counts)),
                 fill = "steelblue", 
                 alpha = 0.7) +
  scale_x_log10(
    breaks = c(0.1, 1, 10, 100, 1000, 10000),
    labels = scales::comma,
    limits = c(0.1, max(qc_results$gene_stats$sd_counts))
  ) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = scales::comma
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 10),
    panel.grid.minor = element_blank()
  ) +
  labs(title = "Distribution of Standard Deviations Across Genes",
       subtitle = paste("Excluding", sum(qc_results$gene_stats$sd_counts == 0), "genes with SD = 0"),
       x = "Standard Deviation of Read Counts (log10 scale)",
       y = "Number of Genes")


# Print summary information
cat("Summary of Standard Deviations:\n")
print(qc_results$summary_stats$sd_summary)
cat("\nNumber of genes with zero SD:", qc_results$summary_stats$zero_sd_genes)
cat("\nNumber of genes with non-zero SD:", qc_results$summary_stats$nonzero_sd_genes)

print(p1)
```

# 5. Differential Gene Expression

### Limma-Voom DEIs: RIX vs RIX

## A. RIX1

```{r}
# RIX1 

# 1. Subset data and verify
relevant_samples <- metadata_filtered$Cross %in% c("CC001xCC019", "CC019xCC001")
metadata_subset <- metadata_filtered[relevant_samples,]
counts_subset <- Master_counts[,relevant_samples]
haplo_subset <- Master_haplo[,relevant_samples]

# Verify sample alignment and print summary
stopifnot(all(colnames(counts_subset) == metadata_subset$Animal.ID))
cat("Number of samples in analysis:", nrow(metadata_subset), "\n")
print(table(metadata_subset$Cross)) # Check sample sizes per cross

Cross = metadata_subset$Cross
Diet = metadata_subset$Diet
Sex = metadata_subset$Sex
mm <- model.matrix(~0 + Cross + Diet + Sex, data = metadata_subset)
d0 <- DGEList(counts_subset)
d0 <- calcNormFactors(d0)

keep <- filterByExpr(d0, mm, large.n =8) 

d <- d0[keep,]
logcpm <- cpm(d, prior.count=2, log=TRUE)
y <- voom(d, mm, plot = F)
fit <- lmFit(y, mm)
contr <- makeContrasts(CrossCC001xCC019 - CrossCC019xCC001, levels = colnames(coef(fit)))
tmp <- contrasts.fit(fit, contr)
tmp <- eBayes(tmp)

top.table <- topTable(tmp, coef = 1, sort.by = "P", n = Inf)
top.table$Gene <- rownames(top.table)
top.table <- top.table[,c("Gene", names(top.table)[1:6])]

base_ids <- sub("_.*$", "", top.table$Gene)

top.table <- data.frame(top.table,anno_filtered[match(base_ids,anno_filtered$ensembl_gene_id),],logcpm[match(top.table$Gene,rownames(logcpm)),])
colnames(top.table) <- sub("^X", "", colnames(top.table))
write.table(top.table, file = "Results/DEIs/ASE_RIX1_DEGs.txt", row.names = F, sep = "\t", quote = F)
length(which(top.table$adj.P.Val < 0.05))

# 16 DEIs
```

```{r}
# RIX1 (males only)

# 1. Initial sex-specific subsetting and verification
metadata_males <- metadata_filtered %>% 
    filter(Sex == "male")
male_ids <- as.character(metadata_males$Animal.ID)
counts_males <- Master_counts[, male_ids]

# Verify sex-specific subsetting
stopifnot(all(colnames(counts_males) == metadata_males$Animal.ID))
cat("Number of male samples in metadata:", nrow(metadata_males), "\n")
cat("Number of male samples in counts:", ncol(counts_males), "\n")


# 2. Further subset to specific crosses
relevant_samples <- metadata_males$Cross %in% c("CC001xCC019", "CC019xCC001")
metadata_subset <- metadata_males[relevant_samples,]
counts_subset <- counts_males[,relevant_samples]

# Verify cross-specific subsetting
cat("\nSample sizes per cross:\n")
print(table(metadata_subset$Cross))
stopifnot(all(colnames(counts_subset) == metadata_subset$Animal.ID))

# 3. Set up model matrix (note: Sex removed since all male)
Cross = metadata_subset$Cross
Diet = metadata_subset$Diet
mm <- model.matrix(~0 + Cross + Diet, data = metadata_subset)

# 4. DGE analysis pipeline
d0 <- DGEList(counts_subset)
d0 <- calcNormFactors(d0)
keep <- filterByExpr(d0, mm, large.n =8) 
#keep <- filterByExpr(d0, mm, min.count = 60, min.total.count = 100)
cat("\nNumber of genes retained:", sum(keep), "\n")
d <- d0[keep,]
logcpm <- cpm(d, prior.count=2, log=TRUE)
y <- voom(d, mm, plot = F)
fit <- lmFit(y, mm)
contr <- makeContrasts(CrossCC001xCC019 - CrossCC019xCC001, 
                      levels = colnames(coef(fit)))
tmp <- contrasts.fit(fit, contr)
tmp <- eBayes(tmp)

# 5. Results processing
top.table <- topTable(tmp, coef = 1, sort.by = "P", n = Inf)
top.table$Gene <- rownames(top.table)
top.table <- top.table[,c("Gene", names(top.table)[1:6])]
base_ids <- sub("_.*$", "", top.table$Gene)
top.table <- data.frame(top.table,anno_filtered[match(base_ids,anno_filtered$ensembl_gene_id),],logcpm[match(top.table$Gene,rownames(logcpm)),])
colnames(top.table) <- sub("^X", "", colnames(top.table))

write.table(top.table, file = "Results/DEIs/ASE_M_RIX1_DEGs.txt", row.names = F, sep = "\t", quote = F)

# 6. Print summary of results
cat("\nNumber of DEGs (FDR < 0.05):", length(which(top.table$adj.P.Val < 0.05)), "\n")

# 33 DEIs
```

```{r}
# RIX1 (females only)

# 1. Initial sex-specific subsetting and verification
metadata_females <- metadata_filtered %>% 
    filter(Sex == "female")
female_ids <- as.character(metadata_females$Animal.ID)
counts_females <- Master_counts[, female_ids]

# Verify sex-specific subsetting
stopifnot(all(colnames(counts_females) == metadata_females$Animal.ID))
cat("Number of female samples in metadata:", nrow(metadata_females), "\n")
cat("Number of female samples in counts:", ncol(counts_females), "\n")


# 2. Further subset to specific crosses
relevant_samples <- metadata_females$Cross %in% c("CC001xCC019", "CC019xCC001")
metadata_subset <- metadata_females[relevant_samples,]
counts_subset <- counts_females[,relevant_samples]

# Verify cross-specific subsetting
cat("\nSample sizes per cross:\n")
print(table(metadata_subset$Cross))
stopifnot(all(colnames(counts_subset) == metadata_subset$Animal.ID))

# 3. Set up model matrix (note: Sex removed since all female)
Cross = metadata_subset$Cross
Diet = metadata_subset$Diet
mm <- model.matrix(~0 + Cross + Diet, data = metadata_subset)

# 4. DGE analysis pipeline
d0 <- DGEList(counts_subset)
d0 <- calcNormFactors(d0)
keep <- filterByExpr(d0, mm, large.n =8) 
#keep <- filterByExpr(d0, mm, min.count = 60, min.total.count = 100)
cat("\nNumber of genes retained:", sum(keep), "\n")
d <- d0[keep,]
logcpm <- cpm(d, prior.count=2, log=TRUE)
y <- voom(d, mm, plot = F)
fit <- lmFit(y, mm)
contr <- makeContrasts(CrossCC001xCC019 - CrossCC019xCC001, 
                      levels = colnames(coef(fit)))
tmp <- contrasts.fit(fit, contr)
tmp <- eBayes(tmp)

# 5. Results processing
top.table <- topTable(tmp, coef = 1, sort.by = "P", n = Inf)
top.table$Gene <- rownames(top.table)
top.table <- top.table[,c("Gene", names(top.table)[1:6])]
base_ids <- sub("_.*$", "", top.table$Gene)
top.table <- data.frame(top.table,anno_filtered[match(base_ids,anno_filtered$ensembl_gene_id),],logcpm[match(top.table$Gene,rownames(logcpm)),])
colnames(top.table) <- sub("^X", "", colnames(top.table))

write.table(top.table, file = "Results/DEIs/ASE_F_RIX1_DEGs.txt", row.names = F, sep = "\t", quote = F)

# 6. Print summary of results
cat("\nNumber of DEGs (FDR < 0.05):", length(which(top.table$adj.P.Val < 0.05)), "\n")

# 5 DEIs -- interestingly far less than males (not the case for DEGs) and less than combined M/F 
```

```{r}
# RIX1 
# incorporating haplotype info

deg_results <- top.table[top.table$adj.P.Val < 0.05,]
deg_genes <- rownames(deg_results)

# Create a summary for each DEG
deg_summaries <- lapply(deg_genes, function(gene) {
    # Get expression info
    expr_data <- data.frame(
        Gene = gene,
        external_gene_name = deg_results[gene, "external_gene_name"],  # Add this line
        logFC = deg_results[gene, "logFC"],
        AveExpr = deg_results[gene, "AveExpr"],
        P.Value = deg_results[gene, "P.Value"],
        adj.P.Val = deg_results[gene, "adj.P.Val"]
    )
    
    # Get haplotype info for each cross
    haplos_01x19 <- as.character(haplo_subset[gene, metadata_subset$Cross == "CC001xCC019"])
    haplos_19x01 <- as.character(haplo_subset[gene, metadata_subset$Cross == "CC019xCC001"])
    
    # Clean haplotype strings
    haplos_01x19 <- gsub(".*\t", "", haplos_01x19)
    haplos_19x01 <- gsub(".*\t", "", haplos_19x01)
    
    # Get haplotype frequencies
    freq_01x19 <- table(haplos_01x19)
    freq_19x01 <- table(haplos_19x01)
    
    # Add haplotype summary
    expr_data$CC001xCC019_haplos <- paste(names(freq_01x19), ":", freq_01x19, collapse="; ")
    expr_data$CC019xCC001_haplos <- paste(names(freq_19x01), ":", freq_19x01, collapse="; ")
    
    # Add dominant haplotype
    expr_data$dominant_01x19 <- names(freq_01x19)[which.max(freq_01x19)]
    expr_data$dominant_19x01 <- names(freq_19x01)[which.max(freq_19x01)]
    
    return(expr_data)
})

# Combine all summaries
deg_summary_table <- do.call(rbind, deg_summaries)

# Sort by adjusted p-value
deg_summary_table <- deg_summary_table[order(deg_summary_table$adj.P.Val),]

# Add a pattern classification column
deg_summary_table$pattern <- ifelse(deg_summary_table$logFC > 0,
                                  "Higher in CC001xCC019",
                                  "Higher in CC019xCC001")

# Add a haplotype consistency column
deg_summary_table$haplo_consistency <- ifelse(deg_summary_table$dominant_01x19 == deg_summary_table$dominant_19x01,
                                            "Consistent",
                                            "Different")

# Add overall summary
total_degs <- nrow(deg_summary_table)
different_haplos <- sum(deg_summary_table$haplo_consistency == "Different")
same_haplos <- sum(deg_summary_table$haplo_consistency == "Consistent")

cat("\n================================================================\n")
cat("OVERALL SUMMARY:\n")
cat(sprintf("Total number of DEGs: %d\n", total_degs))
cat(sprintf("DEGs with different haplotypes between crosses: %d (%.1f%%)\n", 
            different_haplos, (different_haplos/total_degs)*100))
cat(sprintf("DEGs with consistent haplotypes between crosses: %d (%.1f%%)\n",
            same_haplos, (same_haplos/total_degs)*100))

# Print results for each DEG
for(i in 1:nrow(deg_summary_table)) {
    gene <- deg_summary_table$Gene[i]
    cat("\n================================================================\n")
    cat(sprintf("Gene: %s (%s)\n", gene, deg_summary_table$external_gene_name[i]))  # Updated this line
    cat(sprintf("Expression Pattern:\n"))
    cat(sprintf("  LogFC: %.3f (%s)\n", 
                deg_summary_table$logFC[i],
                deg_summary_table$pattern[i]))
    cat(sprintf("  Adjusted p-value: %.3e\n", deg_summary_table$adj.P.Val[i]))
    cat(sprintf("Haplotype Distribution:\n"))
    cat(sprintf("  CC001xCC019: %s\n", deg_summary_table$CC001xCC019_haplos[i]))
    cat(sprintf("  CC019xCC001: %s\n", deg_summary_table$CC019xCC001_haplos[i]))
    cat(sprintf("Dominant Haplotypes:\n"))
    cat(sprintf("  CC001xCC019: %s\n", deg_summary_table$dominant_01x19[i]))
    cat(sprintf("  CC019xCC001: %s\n", deg_summary_table$dominant_19x01[i]))
    cat(sprintf("Haplotype Pattern: %s\n", deg_summary_table$haplo_consistency[i]))
}

# Save the full summary table
write.table(deg_summary_table, 
            file = "Results/DEIs/RIX1_DEI_haplo_summary.txt", 
            sep = "\t", 
            row.names = FALSE, 
            quote = FALSE)

# 7/16 DEGs are DEIs with differenting avg haplotypes between crosses 

```

```{r}
# RIX1
# Run this AFTER running specific RIX DEI and haplo code chunks above 

# Key note: as is, my analysis is only determining DEIs when their expression levels are sig diff, but what about when a RIX is expressing 2 alleles? If both RIX are, and they aren't sig diff in net differences, I'd never know. need to figure out how to assess this -- maybe looking at range/std of each gene's expression, then graph ones wiht large range? - TBD 

# Create founder strain mapping
founder_strains <- c(
    "AA" = "A/J",
    "BB" = "C57BL/6J",
    "CC" = "129S1/SvImJ",
    "DD" = "NOD/ShiLtJ",
    "EE" = "NZO/HlLtJ",
    "FF" = "CAST/EiJ",
    "GG" = "PWK/PhJ",
    "HH" = "WSB/EiJ"
)

# Filter for DEGs with different haplotypes
diff_haplo_degs <- deg_summary_table[deg_summary_table$haplo_consistency == "Consistent", ]
# change to diff 

# Create plots for each gene
for(i in 1:nrow(diff_haplo_degs)) {
    # Get current gene info
    gene_id <- diff_haplo_degs$Gene[i]
    gene_name <- diff_haplo_degs$external_gene_name[i]
    
    # Create data frame for current gene - using the gene row from counts_subset
    plot_data <- data.frame(
        Expression = unlist(counts_subset[rownames(counts_subset) == gene_id, ]),
        Cross = metadata_subset$Cross,
        Haplotype = as.character(haplo_subset[rownames(haplo_subset) == gene_id, ])
    )
    
    # Get unique haplotypes for this gene and their founder strains
    unique_haplos <- unique(plot_data$Haplotype)
    haplo_labels <- paste(unique_haplos, "-", founder_strains[unique_haplos])
    
    # Set up colors for the unique haplotypes
    haplo_colors <- setNames(
        rainbow(length(unique_haplos)), 
        unique_haplos
    )
    
    # Create plot
    p <- ggplot(plot_data, aes(x = Cross, y = Expression)) +
        # Add boxplot with transparent fill
        geom_boxplot(fill = "grey90", alpha = 0.5, outlier.shape = NA) +
        # Add points colored by haplotype
        geom_jitter(aes(color = Haplotype), width = 0.2, size = 2) +
        # Set up colors and labels for haplotypes
        scale_color_manual(
            values = haplo_colors,
            labels = haplo_labels,
            name = "Founder Strains"
        ) +
        theme_bw() +
        theme(
            axis.text.x = element_text(angle = 45, hjust = 1),
            plot.title = element_text(hjust = 0.5, face = "bold"),
            panel.grid.major.x = element_blank(),
            legend.position = "bottom",
            legend.box.margin = margin(t = -10),
            plot.margin = margin(b = 40, l = 5, r = 5, t = 5),
            plot.caption = element_text(hjust = 0.5, size = 10)
        ) +
        labs(
            title = gene_name,
            y = "Log2 CPM",
            x = NULL,
            caption = sprintf("logFC = %.2f     FDR = %.2e", 
                            diff_haplo_degs$logFC[i],
                            diff_haplo_degs$adj.P.Val[i])
        )
    
    # Save plot with gene name in filename
    filename <- paste0("Results/Plots/RIX1/", gene_name, "_DEG_boxplot.png")
    ggsave(filename, plot = p, width = 7, height = 8, dpi = 300)
}
```

## B. RIX2

```{r}
# RIX2 

# 1. Subset data and verify
relevant_samples <- metadata_filtered$Cross %in% c("CC019xCC040", "CC040xCC019")
metadata_subset <- metadata_filtered[relevant_samples,]
counts_subset <- Master_counts[,relevant_samples]
haplo_subset <- Master_haplo[,relevant_samples]

# Verify sample alignment and print summary
stopifnot(all(colnames(counts_subset) == metadata_subset$Animal.ID))
cat("Number of samples in analysis:", nrow(metadata_subset), "\n")
print(table(metadata_subset$Cross)) # Check sample sizes per cross


Cross = metadata_subset$Cross
Diet = metadata_subset$Diet
Sex = metadata_subset$Sex
mm <- model.matrix(~0 + Cross + Diet + Sex, data = metadata_subset)
d0 <- DGEList(counts_subset)
d0 <- calcNormFactors(d0)

keep <- filterByExpr(d0, mm, large.n =8) 

d <- d0[keep,]
logcpm <- cpm(d, prior.count=2, log=TRUE)
y <- voom(d, mm, plot = F)
fit <- lmFit(y, mm)
contr <- makeContrasts(CrossCC019xCC040 - CrossCC040xCC019,
                     levels = colnames(coef(fit)))
tmp <- contrasts.fit(fit, contr)
tmp <- eBayes(tmp)

top.table <- topTable(tmp, coef = 1, sort.by = "P", n = Inf)
top.table$Gene <- rownames(top.table)
top.table <- top.table[,c("Gene", names(top.table)[1:6])]

base_ids <- sub("_.*$", "", top.table$Gene)

top.table <- data.frame(top.table,anno_filtered[match(base_ids,anno_filtered$ensembl_gene_id),],logcpm[match(top.table$Gene,rownames(logcpm)),])
colnames(top.table) <- sub("^X", "", colnames(top.table))
#write.table(top.table, file = "Results/DEIs/ASE_RIX2_DEGs.txt", row.names = F, sep = "\t", quote = F)
length(which(top.table$adj.P.Val < 0.05))

# 889 DEGs!
```

```{r}
# RIX2 (males only)

# 1. Initial sex-specific subsetting and verification
metadata_males <- metadata_filtered[metadata_filtered$Sex == "male", ]
male_ids <- as.character(metadata_males$Animal.ID)
counts_males <- Master_counts[, male_ids]

# Verify sex-specific subsetting
stopifnot(all(colnames(counts_males) == metadata_males$Animal.ID))
cat("Number of male samples in metadata:", nrow(metadata_males), "\n")
cat("Number of male samples in counts:", ncol(counts_males), "\n")

# 2. Further subset to specific crosses
relevant_samples <- metadata_males$Cross %in% c("CC019xCC040", "CC040xCC019")
metadata_subset <- metadata_males[relevant_samples,]
counts_subset <- counts_males[,relevant_samples]

# Verify cross-specific subsetting
cat("\nSample sizes per cross:\n")
print(table(metadata_subset$Cross))
stopifnot(all(colnames(counts_subset) == metadata_subset$Animal.ID))

# 3. Set up model matrix (note: Sex removed since all male)
Cross = metadata_subset$Cross
Diet = metadata_subset$Diet
mm <- model.matrix(~0 + Cross + Diet, data = metadata_subset)

# 4. DGE analysis pipeline
d0 <- DGEList(counts_subset)
d0 <- calcNormFactors(d0)
keep <- filterByExpr(d0, mm, large.n =8) 
#keep <- filterByExpr(d0, mm, min.count = 60, min.total.count = 100)
cat("\nNumber of genes retained:", sum(keep), "\n")
d <- d0[keep,]
logcpm <- cpm(d, prior.count=2, log=TRUE)
y <- voom(d, mm, plot = F)
fit <- lmFit(y, mm)
contr <- makeContrasts(CrossCC019xCC040 - CrossCC040xCC019, 
                     levels = colnames(coef(fit)))
tmp <- contrasts.fit(fit, contr)
tmp <- eBayes(tmp)

# 5. Results processing
top.table <- topTable(tmp, coef = 1, sort.by = "P", n = Inf)
top.table$Gene <- rownames(top.table)
top.table <- top.table[,c("Gene", names(top.table)[1:6])]
base_ids <- sub("_.*$", "", top.table$Gene)
top.table <- data.frame(top.table,anno_filtered[match(base_ids,anno_filtered$ensembl_gene_id),],logcpm[match(top.table$Gene,rownames(logcpm)),])
colnames(top.table) <- sub("^X", "", colnames(top.table))

write.table(top.table, file = "Results/DEIs/ASE_M_RIX2_DEGs.txt", row.names = F, sep = "\t", quote = F)

# 6. Print summary of results
cat("\nNumber of DEGs (FDR < 0.05):", length(which(top.table$adj.P.Val < 0.05)), "\n")

# 289 DEIs
```

```{r}
# RIX2 (females only)

# 1. Initial sex-specific subsetting and verification
metadata_females <- metadata_filtered[metadata_filtered$Sex == "female", ]
female_ids <- as.character(metadata_females$Animal.ID)
counts_females <- Master_counts[, female_ids]

# Verify sex-specific subsetting
stopifnot(all(colnames(counts_females) == metadata_females$Animal.ID))
cat("Number of female samples in metadata:", nrow(metadata_females), "\n")
cat("Number of female samples in counts:", ncol(counts_females), "\n")

# 2. Further subset to specific crosses
relevant_samples <- metadata_females$Cross %in% c("CC019xCC040", "CC040xCC019")
metadata_subset <- metadata_females[relevant_samples,]
counts_subset <- counts_females[,relevant_samples]

# Verify cross-specific subsetting
cat("\nSample sizes per cross:\n")
print(table(metadata_subset$Cross))
stopifnot(all(colnames(counts_subset) == metadata_subset$Animal.ID))

# 3. Set up model matrix (note: Sex removed since all male)
Cross = metadata_subset$Cross
Diet = metadata_subset$Diet
mm <- model.matrix(~0 + Cross + Diet, data = metadata_subset)

# 4. DGE analysis pipeline
d0 <- DGEList(counts_subset)
d0 <- calcNormFactors(d0)
keep <- filterByExpr(d0, mm, large.n =8) 
#keep <- filterByExpr(d0, mm, min.count = 60, min.total.count = 100)
cat("\nNumber of genes retained:", sum(keep), "\n")
d <- d0[keep,]
logcpm <- cpm(d, prior.count=2, log=TRUE)
y <- voom(d, mm, plot = F)
fit <- lmFit(y, mm)
contr <- makeContrasts(CrossCC019xCC040 - CrossCC040xCC019, 
                     levels = colnames(coef(fit)))
tmp <- contrasts.fit(fit, contr)
tmp <- eBayes(tmp)

# 5. Results processing
top.table <- topTable(tmp, coef = 1, sort.by = "P", n = Inf)
top.table$Gene <- rownames(top.table)
top.table <- top.table[,c("Gene", names(top.table)[1:6])]
base_ids <- sub("_.*$", "", top.table$Gene)
top.table <- data.frame(top.table,anno_filtered[match(base_ids,anno_filtered$ensembl_gene_id),],logcpm[match(top.table$Gene,rownames(logcpm)),])
colnames(top.table) <- sub("^X", "", colnames(top.table))

write.table(top.table, file = "Results/DEIs/ASE_F_RIX2_DEGs.txt", row.names = F, sep = "\t", quote = F)

# 6. Print summary of results
cat("\nNumber of DEGs (FDR < 0.05):", length(which(top.table$adj.P.Val < 0.05)), "\n")

# 96 DEIs -- also interesting. Less than males again 
```

```{r}
# RIX2
# incorporating haplotype info

deg_results <- top.table[top.table$adj.P.Val < 0.05,]
deg_genes <- rownames(deg_results)

# Create a summary for each DEG
deg_summaries <- lapply(deg_genes, function(gene) {
    # Get expression info
    expr_data <- data.frame(
        Gene = gene,
        external_gene_name = deg_results[gene, "external_gene_name"],
        logFC = deg_results[gene, "logFC"],
        AveExpr = deg_results[gene, "AveExpr"],
        P.Value = deg_results[gene, "P.Value"],
        adj.P.Val = deg_results[gene, "adj.P.Val"]
    )
    
    # Get haplotype info for each cross
    haplos_19x40 <- as.character(haplo_subset[gene, metadata_subset$Cross == "CC019xCC040"])
    haplos_40x19 <- as.character(haplo_subset[gene, metadata_subset$Cross == "CC040xCC019"])
    
    # Clean haplotype strings
    haplos_19x40 <- gsub(".*\t", "", haplos_19x40)
    haplos_40x19 <- gsub(".*\t", "", haplos_40x19)
    
    # Get haplotype frequencies
    freq_19x40 <- table(haplos_19x40)
    freq_40x19 <- table(haplos_40x19)
    
    # Add haplotype summary
    expr_data$CC019xCC040_haplos <- paste(names(freq_19x40), ":", freq_19x40, collapse="; ")
    expr_data$CC040xCC019_haplos <- paste(names(freq_40x19), ":", freq_40x19, collapse="; ")
    
    # Add dominant haplotype
    expr_data$dominant_19x40 <- names(freq_19x40)[which.max(freq_19x40)]
    expr_data$dominant_40x19 <- names(freq_40x19)[which.max(freq_40x19)]
    
    return(expr_data)
})

# Combine all summaries
deg_summary_table <- do.call(rbind, deg_summaries)

# Sort by adjusted p-value
deg_summary_table <- deg_summary_table[order(deg_summary_table$adj.P.Val),]

# Add a pattern classification column
deg_summary_table$pattern <- ifelse(deg_summary_table$logFC > 0,
                                  "Higher in CC019xCC040",
                                  "Higher in CC040xCC019")

# Add a haplotype consistency column
deg_summary_table$haplo_consistency <- ifelse(deg_summary_table$dominant_19x40 == deg_summary_table$dominant_40x19,
                                            "Consistent",
                                            "Different")

# Add overall summary
total_degs <- nrow(deg_summary_table)
different_haplos <- sum(deg_summary_table$haplo_consistency == "Different")
same_haplos <- sum(deg_summary_table$haplo_consistency == "Consistent")

cat("\n================================================================\n")
cat("OVERALL SUMMARY:\n")
cat(sprintf("Total number of DEGs: %d\n", total_degs))
cat(sprintf("DEGs with different haplotypes between crosses: %d (%.1f%%)\n", 
            different_haplos, (different_haplos/total_degs)*100))
cat(sprintf("DEGs with consistent haplotypes between crosses: %d (%.1f%%)\n",
            same_haplos, (same_haplos/total_degs)*100))

# Print results for each DEG
for(i in 1:nrow(deg_summary_table)) {
    gene <- deg_summary_table$Gene[i]
    cat("\n================================================================\n")
    cat(sprintf("Gene: %s\n", gene))
    cat(sprintf("Expression Pattern:\n"))
    cat(sprintf("  LogFC: %.3f (%s)\n", 
                deg_summary_table$logFC[i],
                deg_summary_table$pattern[i]))
    cat(sprintf("  Adjusted p-value: %.3e\n", deg_summary_table$adj.P.Val[i]))
    cat(sprintf("Haplotype Distribution:\n"))
    cat(sprintf("  CC019xCC040: %s\n", deg_summary_table$CC019xCC040_haplos[i]))
    cat(sprintf("  CC040xCC019: %s\n", deg_summary_table$CC040xCC019_haplos[i]))
    cat(sprintf("Dominant Haplotypes:\n"))
    cat(sprintf("  CC019xCC040: %s\n", deg_summary_table$dominant_19x40[i]))
    cat(sprintf("  CC040xCC019: %s\n", deg_summary_table$dominant_40x19[i]))
    cat(sprintf("Haplotype Pattern: %s\n", deg_summary_table$haplo_consistency[i]))
}

# Save the full summary table
write.table(deg_summary_table, 
            file = "Results/DEIs/RIX2_DEI_haplo_summary.txt", 
            sep = "\t", 
            row.names = FALSE, 
            quote = FALSE)

# 83/889 DEGs are DEIs with differenting avg haplotypes between crosses 
```

```{r}
# RIX2
# Run this AFTER running specific RIX DEI and haplo code chunks above 

# Create founder strain mapping
founder_strains <- c(
    "AA" = "A/J",
    "BB" = "C57BL/6J",
    "CC" = "129S1/SvImJ",
    "DD" = "NOD/ShiLtJ",
    "EE" = "NZO/HlLtJ",
    "FF" = "CAST/EiJ",
    "GG" = "PWK/PhJ",
    "HH" = "WSB/EiJ"
)

# Filter for DEGs with different haplotypes
diff_haplo_degs <- deg_summary_table[deg_summary_table$haplo_consistency == "Different", ]

# Create plots for each gene
for(i in 1:nrow(diff_haplo_degs)) {
    # Get current gene info
    gene_id <- diff_haplo_degs$Gene[i]
    gene_name <- diff_haplo_degs$external_gene_name[i]
    
    # Create data frame for current gene - using the gene row from counts_subset
    plot_data <- data.frame(
        Expression = unlist(counts_subset[rownames(counts_subset) == gene_id, ]),
        Cross = metadata_subset$Cross,
        Haplotype = as.character(haplo_subset[rownames(haplo_subset) == gene_id, ])
    )
    
    # Get unique haplotypes for this gene and their founder strains
    unique_haplos <- unique(plot_data$Haplotype)
    haplo_labels <- paste(unique_haplos, "-", founder_strains[unique_haplos])
    
    # Set up colors for the unique haplotypes
    haplo_colors <- setNames(
        rainbow(length(unique_haplos)), 
        unique_haplos
    )
    
    # Create plot
    p <- ggplot(plot_data, aes(x = Cross, y = Expression)) +
        # Add boxplot with transparent fill
        geom_boxplot(fill = "grey90", alpha = 0.5, outlier.shape = NA) +
        # Add points colored by haplotype
        geom_jitter(aes(color = Haplotype), width = 0.2, size = 2) +
        # Set up colors and labels for haplotypes
        scale_color_manual(
            values = haplo_colors,
            labels = haplo_labels,
            name = "Founder Strains"
        ) +
        theme_bw() +
        theme(
            axis.text.x = element_text(angle = 45, hjust = 1),
            plot.title = element_text(hjust = 0.5, face = "bold"),
            panel.grid.major.x = element_blank(),
            legend.position = "bottom",
            legend.box.margin = margin(t = -10),
            plot.margin = margin(b = 40, l = 5, r = 5, t = 5),
            plot.caption = element_text(hjust = 0.5, size = 10)
        ) +
        labs(
            title = gene_name,
            y = "Log2 CPM",
            x = NULL,
            caption = sprintf("logFC = %.2f     FDR = %.2e", 
                            diff_haplo_degs$logFC[i],
                            diff_haplo_degs$adj.P.Val[i])
        )
    
     # Save plot with gene name in filename
    filename <- paste0("Results/Plots/RIX2/", gene_name, "_DEG_boxplot.png")
    ggsave(filename, plot = p, width = 7, height = 8, dpi = 300)
}
```

```{r}
# RIX2 DEI (Different haplotypes) correlation with phenotypes 

# Set up df 
# Read the tab-delimited file
data <- read.delim("./Results/DEIs/RIX2_DEI_haplo_summary.txt", header = TRUE, sep = "\t")

# Filter rows where haplo_consistency is "Different"
different_genes <- data[data$haplo_consistency == "Different", ]

# Save the filtered data to a new file
write.table(different_genes, 
            file = "./Results/DEIs/RIX2_DEIs_different_haplo_genes.txt", 
            sep = "\t",
            row.names = FALSE,
            quote = FALSE)


# Extract only the first 2 columns into a new dataframe
RIX2_DEI_diff_haplo_genes <- different_genes[, 1:2]

# If you want to save this new dataframe to a file:
write.table(RIX2_DEI_diff_haplo_genes, 
            file = "./Results/DEIs/RIX2_DEI_diff_haplo_genes.txt", 
            sep = "\t",
            row.names = FALSE,
            quote = FALSE)
```

## C. RIX3

```{r}
# CC001xCC040 RIX (RIX3)
# note: we don't have phenotype data for this cross, so likely not analyzing DEG data. 

Cross = metadata_filtered$Cross
Diet = metadata_filtered$Diet
Sex = metadata_filtered$Sex
mm <- model.matrix(~0 + Cross + Diet + Sex, data = metadata_filtered)
d0 <- DGEList(Master_counts)
d0 <- calcNormFactors(d0)

keep <- filterByExpr(d0, mm, large.n =8) 

d <- d0[keep,]
logcpm <- cpm(d, prior.count=2, log=TRUE)
y <- voom(d, mm, plot = F)
fit <- lmFit(y, mm)
contr <- makeContrasts(CrossCC001xCC040 - CrossCC040xCC001,
                     levels = colnames(coef(fit)))
tmp <- contrasts.fit(fit, contr)
tmp <- eBayes(tmp)

top.table <- topTable(tmp, coef = 1, sort.by = "P", n = Inf)
top.table$Gene <- rownames(top.table)
top.table <- top.table[,c("Gene", names(top.table)[1:6])]

base_ids <- sub("_.*$", "", top.table$Gene)

top.table <- data.frame(top.table,anno_filtered[match(base_ids,anno_filtered$ensembl_gene_id),],logcpm[match(top.table$Gene,rownames(logcpm)),])
colnames(top.table) <- sub("^X", "", colnames(top.table))
#write.table(top.table, file = "Data/ASE_RIX2_DEGs.txt", row.names = F, sep = "\t", quote = F)
length(which(top.table$adj.P.Val < 0.05))

# 332 DEGs!
```

# 6. ASE DEGs overlap with standard RNA-seq DEGs

```{r}
# RIX2
# Note RIX1 doesn't have standard RNA-seq DEGs (1 for females only), so can only do this overlap analysis with RIX2 

infile1 <- "/90daydata/do2_projects/Data4R/CCRIX/Data/2_3_25/RIX2_DEGs.txt"
RIX2_DEG <- read.delim(infile1)

infile2 <- "/90daydata/do2_projects/Data4R/ASE/Results/DEIs/ASE_RIX2_DEGs.txt"
RIX2_DEI <- read.delim(infile2)
```

```{r}
# Filter both datasets for significant genes (adj.P.Val < 0.05)
sig_DEG <- RIX2_DEG[RIX2_DEG$adj.P.Val < 0.05, ]
sig_DEI <- RIX2_DEI[RIX2_DEI$adj.P.Val < 0.05, ]

# Extract gene lists
DEG_genes <- sig_DEG$Gene.name
DEI_genes <- sig_DEI$external_gene_name

# Find overlapping genes
overlapping_genes <- intersect(DEG_genes, DEI_genes)

# Create a Venn diagram
library(VennDiagram)
venn.diagram(
  x = list(
    DEG = DEG_genes,
    DEI = DEI_genes
  ),
  filename = 'Results/Overlap/gene_overlap_venn.png',
  category.names = c("DEG", "DEI"),
  output = TRUE,
  imagetype = "png",
  height = 3000,
  width = 3000,
  resolution = 300,
  compression = "lzw"
)

# Print summary statistics
cat("Number of significant DEG genes:", length(DEG_genes), "\n")
cat("Number of significant DEI genes:", length(DEI_genes), "\n")
cat("Number of overlapping genes:", length(overlapping_genes), "\n")

# Create a data frame with overlapping genes and their statistics from both analyses
overlap_stats <- data.frame(
  Gene = overlapping_genes,
  DEG_logFC = sig_DEG$logFC[match(overlapping_genes, sig_DEG$Gene.name)],
  DEG_adjPval = sig_DEG$adj.P.Val[match(overlapping_genes, sig_DEG$Gene.name)],
  DEI_logFC = sig_DEI$logFC[match(overlapping_genes, sig_DEI$external_gene_name)],
  DEI_adjPval = sig_DEI$adj.P.Val[match(overlapping_genes, sig_DEI$external_gene_name)]
)

# Write results to files
write.csv(overlap_stats, "Results/Overlap/overlapping_genes_statistics.csv", row.names = FALSE)
writeLines(overlapping_genes, "Results/Overlap/overlapping_genes_list.txt")

# Calculate overlap significance using Fisher's exact test
total_genes <- length(unique(c(RIX2_DEG$Gene.name, RIX2_DEI$external_gene_name)))
overlap_matrix <- matrix(c(
  length(overlapping_genes),                           # Overlapping genes
  length(DEG_genes) - length(overlapping_genes),       # DEG only
  length(DEI_genes) - length(overlapping_genes),       # DEI only
  total_genes - length(unique(c(DEG_genes, DEI_genes))) # Neither
), nrow = 2)

fisher_test <- fisher.test(overlap_matrix)
cat("\nFisher's exact test p-value:", fisher_test$p.value, "\n")

# Optional: Create a scatter plot of logFC values for overlapping genes
library(ggplot2)
ggplot(overlap_stats, aes(x = DEG_logFC, y = DEI_logFC)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", color = "red") +
  theme_minimal() +
  labs(
    x = "DEG log2 Fold Change",
    y = "DEI log2 Fold Change",
    title = "Correlation of log2 Fold Changes in Overlapping Genes"
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray")

# Calculate correlation between logFC values
correlation <- cor.test(overlap_stats$DEG_logFC, overlap_stats$DEI_logFC)
cat("\nCorrelation between logFC values:")
cat("\nPearson's r:", correlation$estimate)
cat("\nP-value:", correlation$p.value, "\n")

# Interpretaion: 
# Fishers Exact test tells us whether the overlap between my two gene sets is statistically significant or just by chance. The extremely small p-value (6.86e-71) indicates that the overlap of 77 genes between my DEG and DEI sets is highly significant
# Pearson's r (0.908): This measures how well the logFC values correlate between your DEG and DEI analyses = very strong positive correlation, with a very low p.val (4.1e-30) = highly significant correlation 
```

```{r}
# DEIs with haplotypes as "different" overlap with concordant DEGs/DEIs 

infile3 <- "/90daydata/do2_projects/Data4R/ASE/Results/DEIs/RIX2_DEG_haplo_summary.txt"
RIX2_haplo <- read.delim(infile3)

infile4 <- "/90daydata/do2_projects/Data4R/ASE/Results/Overlap/overlapping_genes_list.txt"
RIX2_overlap <- read.delim(infile4)
```

```{r}
# Filter for overlapping genes with "Different" haplo_consistency
result <- RIX2_haplo[RIX2_haplo$external_gene_name %in% RIX2_overlap$V1 & 
                    RIX2_haplo$haplo_consistency == "Different", ]

# Print number of overlapping genes
print(paste0("Number of overlapping genes with 'Different' haplo_consistency: ", nrow(result)))

# Write the results to a new file
outfile <- "/90daydata/do2_projects/Data4R/ASE/Results/Overlap/RIX2_different_haplo_overlap.txt"
write.table(result, file = outfile, sep = "\t", quote = FALSE, row.names = FALSE)

# Interesting result: zero of my RIX2 DEGs, that are also DEIs, had their haplotypes as "different" 
```

# OLD

### DEI overlap with DEGs correlated with Phenotypes (BF%, CHOL, HDL)

```{r}
# CC001xCC019 

# read in data
RIX1_all_significant_DEGs = readRDS("Data/RIX1_all_significant_DEGs_12424")
BF_overlapping_genes = readRDS("../CCRIX/Cleaned_01x19/PhenoXGE/BF_overlapping_genes.rds")
CHOL

DEI_BF_overlapping_genes <- merge(RIX1_all_significant_DEGs, 
                                 BF_overlapping_genes,
                                 by.x = "Gene.stable.ID.version", 
                                 by.y = "Gene")

# After adjusting my min.count (removing super low count transcripts), were left w zero DEIs overlapping w DEGs correlated w BF%


DEI_CHOL_overlapping_genes <- merge(RIX1_all_significant_DEGs, 
                                 CHOL_overlapping_genes,
                                 by.x = "Gene.stable.ID.version", 
                                 by.y = "Gene")

### Snrpn, my strongest DEI in RIX1, is also a DEG and moreover, is correlated with plasma CHOL in RIX1!! -- Snrpn is one of the suggested key imprinted genes responsible for Prader-Willi syndrome! 

DEI_HDL_overlapping_genes <- merge(RIX1_all_significant_DEGs, 
                                 HDL_overlapping_genes,
                                 by.x = "Gene.stable.ID.version", 
                                 by.y = "Gene")
#Also zero genes 
```

### 19x01 RNA-seq outlier samples DEIs

```{r}
RIX_19x01 <- pup[which(pup$Cross %in% c("CC019xCC001")),]

# List of outlier samples
outlier_samples <- c("109", "113", "114", "116", "118", "124", "126", "127")

# Add new 'Outlier' column to RIX_19x01 data frame
RIX_19x01$Outlier <- ifelse(RIX_19x01$Animal.ID %in% outlier_samples, "Yes", "No")


# First ensure both metadata and counts data are properly loaded
# Assuming RIX_19x01 and Master_counts_no_outliers are already loaded

# 1. Get the intersection of sample IDs
common_samples <- intersect(RIX_19x01$Animal.ID, colnames(Master_counts_no_outliers))

# 2. Filter counts data to keep only common samples
counts_filtered <- Master_counts_no_outliers[, common_samples]

# 3. Filter metadata to keep only common samples and ensure same order
metadata_filtered <- RIX_19x01 %>%
  filter(Animal.ID %in% common_samples) %>%
  arrange(match(Animal.ID, colnames(counts_filtered)))

# 4. Verify alignment
stopifnot(
  all(colnames(counts_filtered) == metadata_filtered$Animal.ID),
  nrow(metadata_filtered) == ncol(counts_filtered)
)

# 5. Print summary of filtering
cat("Original number of samples in metadata:", nrow(RIX_19x01), "\n")
cat("Original number of samples in counts:", ncol(Master_counts_no_outliers), "\n")
cat("Number of samples after filtering:", length(common_samples), "\n")

# The resulting counts_filtered and metadata_filtered are now properly aligned

Cross = metadata_filtered$Cross
Diet = metadata_filtered$Diet
Sex = metadata_filtered$Sex
mm <- model.matrix(~0 + Outlier + Diet + Sex, data = metadata_filtered)
d0 <- DGEList(counts_filtered)
d0 <- calcNormFactors(d0)

keep <- filterByExpr(d0, mm, large.n =8) 

d <- d0[keep,]
logcpm <- cpm(d, prior.count=2, log=TRUE)
y <- voom(d, mm, plot = F)
fit <- lmFit(y, mm)
contr <- makeContrasts(OutlierNo - OutlierYes, levels = colnames(coef(fit)))
tmp <- contrasts.fit(fit, contr)
tmp <- eBayes(tmp)

top.table <- topTable(tmp, coef = 1, sort.by = "P", n = Inf)
top.table$Gene <- rownames(top.table)
top.table <- top.table[,c("Gene", names(top.table)[1:6])]

base_ids <- sub("_.*$", "", top.table$Gene)

top.table <- data.frame(top.table,anno[match(base_ids,anno$Transcript.stable.ID),],logcpm[match(top.table$Gene,rownames(logcpm)),])
colnames(top.table) <- sub("^X", "", colnames(top.table))
#write.table(top.table, file = "ASE_CCRIX_01x19_19x01.txt", row.names = F, sep = "\t", quote = F)
length(which(top.table$adj.P.Val < 0.05))


# Only 1 DEI in this 19x01 outliers vs rest of them contrast: the F3 gene. This gene encodes a membrane-bound glycoprotein that forms the primary physiological initiator of the blood coagulation process following vascular damage. C57 =01, and WSB/NZO =19 - all DEI, so not really ASE result 
```
